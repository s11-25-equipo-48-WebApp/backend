name: üöÄ Despliegue a Render

on:
  push:
    branches:
      - main

jobs:
  trigger-deploy:
    name: üîß Disparar Despliegue + Verificaci√≥n
    runs-on: ubuntu-latest

    steps:
      - name: ‚öôÔ∏è Preparando entorno
        run: |
          echo "Iniciando workflow..."
          # Instalar jq para el procesamiento de JSON en el paso de verificaci√≥n de Swagger
          sudo apt-get update && sudo apt-get install -y jq

      - name: üì° Llamando al Webhook de Render
        run: |
          echo "Ejecutando hook..."
          # Se usa el comando 'true' || para asegurar que el workflow no falle
          # si curl no recibe un status 200 (aunque el deploy se inicie).
          curl -X POST "${{ secrets.RENDER_HOOK }}"
          echo "Hook enviado correctamente ‚úîÔ∏è"

      - name: ‚è≥ Esperando a que Render procese el deploy
        run: |
          echo "Esperando 15 segundos para permitir que Render inicie el build..."
          sleep 15

      - name: ü©∫ Verificando que la app responde (Health Check)
        run: |
          echo "Probando disponibilidad..."
          # La bandera -f hace que curl falle (c√≥digo de salida > 0) para cualquier error HTTP (4xx o 5xx)
          curl -f "https://backend-jnqc.onrender.com/health" \
          && echo "La app est√° arriba üéâ" \
          || (echo "‚ùå Fall√≥ el health-check en https://backend-jnqc.onrender.com/health"; exit 1)

      - name: üìö Obtener lista de endpoints desde Swagger (Verificaci√≥n API)
        # ESTE PASO FUE CORREGIDO EN INDENTACI√ìN
        run: |
          echo "Descargando spec OpenAPI..."
          # Usamos -fs para fail silently y asegurar que solo el JSON se almacena si es exitoso
          JSON=$(curl -fs https://backend-jnqc.onrender.com/docs-json)

          if [ -z "$JSON" ]; then
            echo "‚ùå Fall√≥ la descarga del spec OpenAPI (docs-json). El endpoint puede no estar disponible o el JSON est√° vac√≠o."
            exit 1
          fi

          echo "‚úîÔ∏è Spec obtenido. Extrayendo endpoints..."

          # Extrae las claves (paths) del objeto .paths y cuenta los elementos
          ENDPOINTS=$(echo "$JSON" | jq -r '.paths | keys[]')
          COUNT=$(echo "$JSON" | jq '.paths | length')

          echo "-------------------------------"
          echo "üìå Total de endpoints: $COUNT"
          echo "-------------------------------"
          echo "$ENDPOINTS"
          echo "-------------------------------"

          if [ "$COUNT" -eq 0 ]; then
            echo "‚ùå No se encontraron endpoints. Swagger fall√≥ al mostrar rutas."
            exit 1
          fi
          echo "Verificaci√≥n de endpoints exitosa. Despliegue completo. ‚úÖ"