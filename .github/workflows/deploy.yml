name: ğŸš€ Deploy Render

on:
  push:
    branches:
      - main

jobs:
  trigger-deploy:
    name: ğŸ”§ Disparar Deploy + NotificaciÃ³n
    runs-on: ubuntu-latest

    steps:
      - name: âš™ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¡ Llamar a Render Deploy Hook
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
          --fail

      - name: â±ï¸ Esperar 15 segundos
        run: sleep 15

      - name: ğŸ©º Verificar estado del servicio
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "https://backend-jnqc.onrender.com/docs")
          echo "HTTP Status: $response"
          if [ "$response" -ne 200 ]; then
            exit 1
          fi

      - name: ğŸ“¢ Notificar en Discord
        if: always()
        run: |
          STATUS="${{ job.status }}"
          
          curl -H "Content-Type: application/json" \
          -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          -d "{
            \"username\": \"CI Bot\",
            \"embeds\": [{
              \"title\": \"ğŸš€ Deploy ejecutado\",
              \"description\": \"Resultado del deploy: **$STATUS**\",
              \"color\": $([ \"$STATUS\" = \"success\" ] && echo 3066993 || echo 15158332),
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }"
