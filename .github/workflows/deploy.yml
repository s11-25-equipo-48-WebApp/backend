name: ğŸš€ Despliegue a Render

on:
  push:
    branches:
      - main

jobs:
  trigger-deploy:
    name: ğŸ”§ Disparar Despliegue + VerificaciÃ³n
    runs-on: ubuntu-latest

    steps:
      - name: âš™ï¸ Preparando entorno
        run: |
          echo "Iniciando workflow..."
          # Instalar jq para el procesamiento de JSON en el paso de verificaciÃ³n de Swagger
          sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸ“¡ Llamando al Webhook de Render
        run: |
          echo "Ejecutando hook..."
          # Llama al webhook secreto de Render para iniciar el despliegue
          curl -X POST "${{ secrets.RENDER_HOOK }}"
          echo "Hook enviado correctamente, iniciando despliegue en Render âœ”ï¸"

      - name: ğŸ“š Obtener lista de endpoints desde Swagger (VerificaciÃ³n API)
        run: |
          echo "Descargando spec OpenAPI..."
          JSON=$(curl -fs https://backend-jnqc.onrender.com/docs-json)

          if [ -z "$JSON" ]; then
            echo "âŒ FallÃ³ la descarga del spec OpenAPI (docs-json). El endpoint puede no estar disponible o el JSON estÃ¡ vacÃ­o."
            exit 1
          fi

          echo "âœ”ï¸ Spec obtenido. Extrayendo endpoints..."

          # Usa jq para extraer las rutas (keys) del objeto 'paths'
          ENDPOINTS=$(echo "$JSON" | jq -r '.paths | keys[]')
          COUNT=$(echo "$JSON" | jq '.paths | length')

          echo "-------------------------------"
          echo "ğŸ“Œ Total de endpoints: $COUNT"
          echo "-------------------------------"
          echo "$ENDPOINTS"
          echo "-------------------------------"

          if [ "$COUNT" -eq 0 ]; then
            echo "âŒ No se encontraron endpoints. Swagger fallÃ³ al mostrar rutas."
            exit 1
          fi
          echo "VerificaciÃ³n de endpoints exitosa. Despliegue completo. âœ…"