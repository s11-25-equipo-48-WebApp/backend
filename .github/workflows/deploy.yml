name: üöÄ Despliegue a Render + Verificaci√≥n API + Notificaci√≥n Discord

on:
  push:
    branches:
      - main

jobs:
  trigger-deploy:
    name: üîß Desplegar y Validar
    runs-on: ubuntu-latest

    steps:
      - name: ‚öôÔ∏è Preparando entorno
        run: |
          echo "Iniciando workflow..."
          sudo apt-get update
          sudo apt-get install -y jq

      - name: üì° Ejecutando webhook de Render
        run: |
          echo "Llamando a Render..."
          curl -X POST "${{ secrets.RENDER_HOOK }}"
          echo "Webhook enviado."

      - name: üìö Obtener OpenAPI y mostrar endpoints
        id: swagger
        run: |
          echo "Descargando spec OpenAPI..."
          JSON=$(curl -fs https://backend-jnqc.onrender.com/docs-json)

          if [ -z "$JSON" ]; then
            echo "‚ùå No se pudo obtener el JSON."
            exit 1
          fi

          ENDPOINTS=$(echo "$JSON" | jq -r '.paths | keys[]')
          COUNT=$(echo "$JSON" | jq '.paths | length')

          echo "-------------------------------"
          echo "üìå Total de endpoints: $COUNT"
          echo "-------------------------------"
          echo "$ENDPOINTS"
          echo "-------------------------------"

          # Guardar COUNT normalmente
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          # Guardar ENDPOINTS multil√≠nea
          {
            echo "list<<EOF"
            echo "$ENDPOINTS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: üîî Enviar resultado a Discord
        run: |
          COUNT="${{ steps.swagger.outputs.count }}"
          ENDPOINTS="${{ steps.swagger.outputs.list }}"

          PAYLOAD=$(jq -n \
            --arg c "$COUNT" \
            --arg e "$ENDPOINTS" \
            '{
              username: "GitHub CI",
              content: "üì¢ **Deploy completado**\n\n**Total de endpoints:** \($c)\n\n```\n\($e)\n```"
            }'
          )

          curl -H "Content-Type: application/json" \
            -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -d "$PAYLOAD"

          echo "Notificaci√≥n enviada a Discord ‚úîÔ∏è"
