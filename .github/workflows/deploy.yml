name: üöÄ Despliegue a Render

on:
  push:
    branches:
      - main

jobs:
  trigger-deploy:
    name: üîß Despliegue + Verificaci√≥n
    runs-on: ubuntu-latest

    steps:
      - name: ‚öôÔ∏è Preparando entorno
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: üì° Ejecutando Webhook de Render
        run: |
          curl -X POST "${{ secrets.RENDER_HOOK }}"

      - name: ‚è≥ Esperar a que la API se levante (retry)
        run: |
          for i in {1..10}; do
            echo "Intento $i/10 verificando API..."
            if curl -fs https://backend-jnqc.onrender.com/docs-json > /dev/null; then
              echo "API disponible ‚úîÔ∏è"
              exit 0
            fi
            echo "No disponible a√∫n... esperando 5s"
            sleep 5
          done
          echo "‚ùå API no respondi√≥."
          exit 1

      - name: üìö Obtener lista de endpoints desde Swagger
        run: |
          echo "Descargando spec OpenAPI..."
          JSON=$(curl -fs https://backend-jnqc.onrender.com/docs-json)

          if [ -z "$JSON" ]; then
            echo "‚ùå Fall√≥ la descarga del spec OpenAPI."
            exit 1
          fi

          ENDPOINTS=$(echo "$JSON" | jq -r '.paths | keys[]')
          COUNT=$(echo "$JSON" | jq '.paths | length')

          echo "-------------------------------"
          echo "üìå Total de endpoints: $COUNT"
          echo "-------------------------------"
          echo "$ENDPOINTS"
          echo "-------------------------------"

          if [ "$COUNT" -eq 0 ]; then
            echo "‚ùå No se encontraron endpoints."
            exit 1
          fi

          echo "Verificaci√≥n final exitosa. üëç"
