name: üöÄ Despliegue a Render

on:
  push:
    branches:
      - main

jobs:
  trigger-deploy:
    name: üîß Disparar Despliegue + Verificaci√≥n
    runs-on: ubuntu-latest

    steps:
      - name: ‚öôÔ∏è Preparando entorno
        run: |
          echo "Iniciando workflow..."
          # Instalar jq para el procesamiento de JSON en el paso de verificaci√≥n de Swagger
          sudo apt-get update && sudo apt-get install -y jq

      - name: üì° Llamando al Webhook de Render
        run: |
          echo "Ejecutando hook..."
          # Llama al webhook secreto de Render para iniciar el despliegue
          curl -X POST "${{ secrets.RENDER_HOOK }}"
          echo "Hook enviado correctamente, iniciando despliegue en Render ‚úîÔ∏è"

      - name: ü©∫ Sondeando la disponibilidad de la app (Health Check con Timeout de 10 Minutos)
        run: |
          URL="https://backend-jnqc.onrender.com/health"
          ATTEMPTS=0
          # Configurado para 10 minutos (120 intentos * 5 segundos de espera)
          MAX_ATTEMPTS=120 
          
          echo "Iniciando sondeo de disponibilidad en $URL (M√°ximo 10 minutos)..."
          
          while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
            # Intenta obtener el c√≥digo HTTP. -fs oculta el progreso y fuerza el error en 4xx/5xx.
            # -w "%{http_code}" imprime solo el c√≥digo de respuesta.
            HTTP_CODE=$(curl -fs -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ Health Check exitoso (HTTP $HTTP_CODE) despu√©s de $ATTEMPTS intentos."
              break # La aplicaci√≥n est√° lista, salir del bucle.
            else
              echo "‚è≥ Intento $((ATTEMPTS + 1)) de $MAX_ATTEMPTS: App a√∫n no est√° lista (HTTP $HTTP_CODE). Esperando 5 segundos..."
              ATTEMPTS=$((ATTEMPTS + 1))
              sleep 5
            fi
          done

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "La app est√° arriba üéâ (Despliegue verificado y listo para las pruebas de API)."
          else
            echo "‚ùå Fall√≥ el Health Check despu√©s de $MAX_ATTEMPTS intentos (10 minutos). El despliegue fall√≥ o tard√≥ demasiado en iniciar."
            exit 1 # Forzar la falla del job
          fi

      - name: üìö Obtener lista de endpoints desde Swagger (Verificaci√≥n API)
        run: |
          echo "Descargando spec OpenAPI..."
          JSON=$(curl -fs https://backend-jnqc.onrender.com/docs-json)

          if [ -z "$JSON" ]; then
            echo "‚ùå Fall√≥ la descarga del spec OpenAPI (docs-json). El endpoint puede no estar disponible o el JSON est√° vac√≠o."
            exit 1
          fi

          echo "‚úîÔ∏è Spec obtenido. Extrayendo endpoints..."

          # Usa jq para extraer las rutas (keys) del objeto 'paths'
          ENDPOINTS=$(echo "$JSON" | jq -r '.paths | keys[]')
          COUNT=$(echo "$JSON" | jq '.paths | length')

          echo "-------------------------------"
          echo "üìå Total de endpoints: $COUNT"
          echo "-------------------------------"
          echo "$ENDPOINTS"
          echo "-------------------------------"

          if [ "$COUNT" -eq 0 ]; then
            echo "‚ùå No se encontraron endpoints. Swagger fall√≥ al mostrar rutas."
            exit 1
          fi
          echo "Verificaci√≥n de endpoints exitosa. Despliegue completo. ‚úÖ"