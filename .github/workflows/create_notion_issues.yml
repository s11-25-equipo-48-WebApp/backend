name: Crear Issues desde Notion

on:
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  create_issues:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Crear issues desde archivos .md
        env:
          TOKEN: ${{ secrets.MY_GITHUB_PAT }} # Tu Personal Access Token
          OWNER: s11-25-equipo-48-WebApp
          REPO: backend
        run: |
          ISSUE_DIR="./.notion_issues"

          for file in $ISSUE_DIR/*.md; do
            echo "Procesando $file"

            TITLE=$(head -n 1 "$file" | sed 's/^# //')
            BODY=$(tail -n +2 "$file")

            # Usar jq para generar JSON seguro
            JSON_PAYLOAD=$(jq -n --arg title "$TITLE" --arg body "$BODY" '{title: $title, body: $body}')

            # Crear issue
            curl -s -X POST \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/$OWNER/$REPO/issues \
              -d "$JSON_PAYLOAD"
          done